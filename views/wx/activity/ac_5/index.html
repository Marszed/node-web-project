<!DOCTYPE html> 
<html> 
    <head> 	
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /> 	
        <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1"/>	
        <title>东区特别活动-大师兄广工程东店</title> 	
        <link rel="stylesheet" type="text/css" href="http://s.ksmimi.com/csspro/v0.93/base.css" />	
        <link rel="stylesheet" type="text/css" href="http://s.ksmimi.com/dashixiong_static/csspro/shop.css" />	
        <script src="http://s.ksmimi.com/jspro/v0.93/jquery.js" type="text/javascript"></script>	
        <style>		
            body{			
                background-image: url(http://s.ksmimi.com/imgpro/grid.png);			
                background-repeat: repeat;			
                background-size: auto;			
                background-color : #CCC;			color : #888;		
            }		
            .container{			
                width:80%;			
                max-width:500px;			
                background : #FFF;			
                padding : 20px;			
                margin :  10px auto;			
                border-bottom : 1px solid #CCC;			
                border-right : 1px solid #CCC;		
            }		
            .note{			
                color : #CCC;			
            }		
            li{			
                line-height : 24px;				
            }		
            a{			
                color : orange;			
                }	
                </style>
    </head> 
    <body> 	
<style>
body{
	background : #EEE;	
	max-width : 640px;
	margin : 0 auto;
}	
#guide{
	margin : 0 auto;
	padding : 10px 0;
	font-size : 14px;	
	background : #E9F01D;	
	color : #888;
	text-align : center;

	position : fixed;
	top : 0;

	width : 100%;
	z-index : 9999;
	max-width : 640px;
}

li{
	float : left;	
	width : 33.333333%;
	overflow : hidden;
	margin : 0 0 15px 0;
	/*
	height : 220px;
	*/
}

ul{
	display : block;
	overflow : hidden;
	
}
h4{
	font-size : 22px;	
	font-weight : 700;
	color : #333;
	padding : 10px;
	border-bottom : 1px dashed #CCC;
	margin-bottom : 15px;
}
h5{
	padding : 10px;	
}
#submit_deliver_fee{
	color : red;
	font-size : 24px;
}
#total_num, #total_pay{
	color : orange;
	font-size : 24px;	
}
#total_pay{
    text-decoration:line-through;
}
.container_div{
	background : #EEE;
}
.pd_wrap{
	margin:0 10px;	
}
.section{
	margin-bottom : 50px;	
}

.shop-body{
	margin-top : 30px;	
}
.product-img{
	position : absolute;				
	top : 0px;
	left : 0;
	width:100%;
}
.img_wrap{position:relative;}

.actions div{
	background : red;
	width : 33.33333%;
	float : left;
	text-align : center;
	font-size : 18px;	
	line-height : 30px;
}

.num{
}
.actions{
	display : none;
	width : 100%;
	position : absolute;
	bottom : 0;
}
li.selected{
}
li.selected .actions{
	display : block;
}

.actions .num{
	background : orange;
}
.actions .ac_plus{
	background : green;
}
.submit {
	text-align : center;
	font-size : 18px;
	line-height : 30px;
}

.price{
	color : orange;
}
.submit_actions{
	border : 1 solid #CCC;	
	background : #40A0C0;
}
.submit_actions a {
	display : block;
	color : #FFF;
	line-height : 48px;
}

.closed{
	color : red;
	margin : 34px 0 0 10px;

}
.notice, .notice-info{
	color : red;
	margin : 34px 0 0 10px;
	line-height : 24px;
	padding : 10px 0;
}
.notice h4{
    line-height : 30px;
    color : #FF1493;
}
.notice-info{
	color : green;
}

.ad{
	margin-top : 40px;
}

</style>
<div class="container_div">
	<h3 id="guide">点击图片即可选购, 页面底部 <a href="#submit_form">结账(免费)</a></h3>

    <div class="notice">
        <h4>做不了土豪做土匪！一分钟里, 以下产品下单不要钱！抢到就是你的~ 切记莫要太贪心，因为还有很多人跟你同时抢呢~ 先下手为强！仅限东区的小伙伴哦! 别栋地址不送货，切记。</h4>
    </div>
	
	<div class="shop-body">
	    {{each(section, i) sections}}
		{{if section.products.length}}
		<div class="section">
			<h4>${section.tagName}</h4>
			<ul id="sections">
				{{each(product, i) section.products}}
				<li>
					<div class="pd_wrap">
						<div class="img_wrap">
							<img width="100%" src="http://${env.staticRoot}/dashixiong_static/img/product_bg.jpg" />
							<img class="product-img" id="${product.id}" original="http://img.ksmimi.com/uploads/products/${product.img}"  title="${product.title}" class="product-img" width="100%" src="http://${env.staticRoot}/dashixiong_static/img/product_bg.jpg" />
							<div class="actions"><div class="ac_plus">+</div><div class="num">0</div><div class="ac_minus">-</div></div>
						</div>

						{{if product.promotePrice}}
						<h5><del>${product.price}元</del> <strong class="price">${product.promotePrice}元</strong>/<span class="unit">${product.unit}</span> <span class="title">${product.title}</span></h5>
						{{else}}
						<h5><strong class="price">${product.price}元</strong>/<span class="unit">${product.unit}</span> <span class="title">${product.title}</span></h5>
						{{/if}}
					</div>
				</li>
				{{if (i+1)%3==0 }}
				<li style="clear:both;width:100%;">	
				</li>
				{{/if}}
				{{/each}}
			</ul>	
		</div>
		{{/if}}
		{{/each}} 
		
		<div class="submit">
			<p id="submit_info"><strong id="total_num"></strong>件东西共<strong id="total_pay"></strong>元.不要钱！ </p>
			<p id="submit_none" style="display:none;">购物袋里没有东西哦~</p>
			<p id="submit_deliver_fee" style="display:none;">抓紧时间, 贪心没有好下场哦~ </p>
			<p class="submit_actions"><a id="submit_btn" href="#" onclick="return false;">下单(免费)! &gt;&gt;</a></p>
            <form id="submit_form" action="/dashixiongwx/activity/addr?userId=${user_id}&wx_id=${wx_id}" method="POST">
				<input id="submit_products" name="products" type="hidden"  />
                <input type="hidden" name="shop_id" value="${shop_id}"  />
                <input type="hidden" name="user_id" value="${user_id}"  />
                <input type="hidden" name="shop_name" value="${shop_name}"  />
                <input name="cur_warehouse_id" type="hidden" value="${cur_warehouse_id}"  />
			</form>
		</div>
	</div>
</div>
<script type="text/javascript" src="http://s.ksmimi.com/dashixiong_static/jspro/jquery.lazyload.js"></script>
<script type="text/javascript">
	var bag = [];//购物袋
	var addProductNum = function(ele){
		var $li = $(ele).parents('li');
		var $num = $li.find('.num');
		var num = $num.html();
		var price = $li.find('.price').html();//产品单价
		var unit = $li.find('.unit').html();//产品单位
		var title = $li.find('.title').html();//产品名称
		num -= 0;
        if( num >=1 )return;
		++num;
		price = parseFloat(price);
		$num.html(num);

		console.log(unit , title);

		//往购物袋里加一个东西
		bag.push({
			id : ele.id,
			price : price,
			unit : unit,
			title : title
		});

		//检查一下跑腿费
		checkDeliverFee();

	};
	var reduceProductNum = function(ele){
		var $li = $(ele).parents('li');
		var $num = $li.find('.num');
		var num = $num.html();
		var $img = $li.find('.product-img');
		num -= 0;
		--num;
		if(num<=0){
			num=0;
			$li.removeClass('selected');
		}
		$num.html(num);
		
		//从购物袋中拿掉一个东西
		$.each(bag, function(i, product){
			if(product.id == $img.attr('id')){//找到需要拿掉的商品
				bag.splice(i,1);
				return false;//马上结束循环
			}
		});

		checkDeliverFee();
	};
	
	var count = function(){
		var total_pay = 0;
		var total_num = 0;	
		$('.selected').each(function(i, v){
			var num = $(this).find('.num').html();
			var price = $(this).find('.price').html();
			num -= 0; price = parseFloat(price);
			total_num += num;//累加一下看看总共有多少件产品
			total_pay += (price*num);
		});
		return {
			total_pay : total_pay.toFixed(1),//取得1位小数, 会不会因为这个亏钱啊...?
			total_num : total_num	  
		};
	}
	var checkDeliverFee = function(){
		$('#submit_deliver_fee').show();
	};
	
	var showInfo = function(){
		var total = count();
		if(!total.total_num){
			$('#submit_none').show();
			$('#submit_info').hide();
			return;	
		}

		$('#submit_none').hide();
		$('#submit_info').show();
		$('#total_num').html(total.total_num);
		$('#total_pay').html(total.total_pay);
	};


	$('img.product-img').click(function(e){
		this.blur();
		$('#notice').html('添加了一件 '+this.title);
		$(this).parents('li').addClass('selected');
		addProductNum(this);
		showInfo();
		e.stopPropagation();
	});
	
	$('.actions .ac_plus').click(function(){
		$(this).parents('li').find('img.product-img').trigger('click');
	});
	$('.actions .ac_minus').click(function(e){
		reduceProductNum(this);
		showInfo();
		e.stopPropagation();
	});

	$('#submit_btn').click(function(){
		var json_str = [];
		if(bag.length){
			$.each(bag, function(i, product){
				json_str.push('{"id":'+product.id+',"price":'+product.price+', "title":"'+product.title+'", "unit":"'+product.unit+'"}') ;
			});				
		}else{
			return;
		}
		json_str = json_str.join(',');
		$('#submit_products').val('['+ json_str +']');
		$('#submit_form').submit();
	});

	showInfo();

	$(function(){
		var now = new Date().getHours();
		if(now >=0 && now<8 ){
			$('.closed').show();
		}	
	});
	


	//------------------------ lazyload -----------------------------//
	
	$('img.product-img').lazyload({
		effect : "show"
	});
</script>	</body> </html>
